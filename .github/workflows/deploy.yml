name: deploy-crm

on:
  workflow_dispatch:
  push:
    branches: [main]

concurrency:
  group: deploy-crm
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect frontend/backend dirs
        run: |
          set -e
          if [ -d Frontend ]; then echo "FE_DIR=Frontend" >> "$GITHUB_ENV"; else echo "FE_DIR=frontend" >> "$GITHUB_ENV"; fi
          if [ -d Backend  ]; then echo "BE_DIR=Backend"  >> "$GITHUB_ENV"; else echo "BE_DIR=backend"  >> "$GITHUB_ENV"; fi

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ secrets.NODE_VERSION || '20' }}

      # 1) Пишем prod-env (без CRLF) + страховочный .env
      - name: Write frontend env files (normalize)
        working-directory: ./${{ env.FE_DIR }}
        env:
          FRONTEND_ENV: ${{ secrets.FRONTEND_ENV }}
        run: |
          set -e
          python3 - <<'PY'
          import os
          from pathlib import Path

          data = os.environ.get("FRONTEND_ENV", "")
          data = data.replace("\r\n", "\n").replace("\r", "\n")

          if not data.strip():
              raise SystemExit("FRONTEND_ENV is empty")

          env_prod = Path(".env.production")
          env_prod.write_text(data.rstrip("\n") + "\n", encoding="utf-8")

          # страховка: если build пойдет не в production-mode, Vite всё равно подхватит .env
          Path(".env").write_text(env_prod.read_text(encoding="utf-8"), encoding="utf-8")
          PY

      # 2) Удаляем любые другие .env*, которые могут перебить
      - name: Remove other env files
        working-directory: ./${{ env.FE_DIR }}
        run: |
          set -e
          rm -f .env.local .env.development .env.development.local .env.production.local || true

      # 3) Валидируем и экспортируем VITE_API_URL из .env.production (нормализуем \r, снимаем кавычки, убираем / на конце)
      - name: Validate & export VITE_API_URL
        working-directory: ./${{ env.FE_DIR }}
        run: |
          set -e
          python3 - <<'PY' >> "$GITHUB_ENV"
          import re
          from pathlib import Path

          text = Path(".env.production").read_text(encoding="utf-8")

          m = re.search(r"^VITE_API_URL=(.*)$", text, flags=re.MULTILINE)
          if not m:
              raise SystemExit("VITE_API_URL is missing in FRONTEND_ENV")

          url = m.group(1).strip().replace("\r", "")

          # снять обрамляющие кавычки
          if (url.startswith('"') and url.endswith('"')) or (url.startswith("'") and url.endswith("'")):
              url = url[1:-1].strip()

          url = url.rstrip("/")  # нормализуем

          if not url:
              raise SystemExit("VITE_API_URL is empty after normalization")

          print(f"VITE_API_URL={url}")
          PY

          echo "Exported VITE_API_URL=$VITE_API_URL"

      - name: Install & Build frontend
        working-directory: ./${{ env.FE_DIR }}
        env:
          VITE_API_URL: ${{ env.VITE_API_URL }}
        run: |
          set -e
          npm ci --no-audit --no-fund || npm install --no-audit --no-fund
          # сначала пробуем явно production-mode (для Vite это важно)
          npm run build -- --mode production || npm run build || npm run build:prod

      - name: Detect FE_OUT
        run: |
          set -e
          FE_DIR="${{ env.FE_DIR }}"
          if [ -d "$FE_DIR/dist" ]; then
            FE_OUT="dist"
          elif [ -d "$FE_DIR/build" ]; then
            FE_OUT="build"
          else
            echo "Build dir not found (expected dist/ or build/)" >&2
            exit 1
          fi

          echo "FE_OUT=$FE_OUT" >> "$GITHUB_ENV"
          echo "FE_DIR=$FE_DIR FE_OUT=$FE_OUT"

          test -d "$FE_DIR/$FE_OUT"
          find "$FE_DIR/$FE_OUT" -maxdepth 1 -type f | head -n 10 || true

      - name: Fail if bundle contains bad base url
        env:
          VITE_API_URL: ${{ env.VITE_API_URL }}
        run: |
          set -e
          OUT="${{ env.FE_DIR }}/${{ env.FE_OUT }}"
          URL="${VITE_API_URL//$'\r'/}"
          URL="${URL%/}"

          echo "Searching for '/undefined/' in bundle..."
          if grep -RIn --no-messages "/undefined/" "$OUT" >/dev/null ; then
            echo "Bundle contains '/undefined/'. Check VITE_API_URL!" >&2
            exit 1
          fi

          if [ -z "$URL" ]; then
            echo "VITE_API_URL is missing." >&2
            exit 1
          fi

          if echo "$URL" | grep -Eqi '(localhost|127\.0\.0\.1)'; then
            echo "VITE_API_URL points to localhost. Fix FRONTEND_ENV." >&2
            exit 1
          fi

          # ищем URL и в форме без / и с /
          if ! grep -RInF --no-messages "$URL" "$OUT" >/dev/null && \
             ! grep -RInF --no-messages "${URL}/" "$OUT" >/dev/null; then
            echo "Bundle does not contain VITE_API_URL ($URL). Check env injection/build or frontend code." >&2
            exit 1
          fi

          echo "OK: bundle URLs look clean"

      - name: Pack frontend build
        run: |
          set -e
          tar -C "${{ env.FE_DIR }}" -czf frontend.tgz "${{ env.FE_OUT }}"

      - name: Upload frontend archive
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          port: ${{ secrets.SSH_PORT || 22 }}
          key: ${{ secrets.VPS_SSH_KEY }}
          passphrase: ${{ secrets.VPS_SSH_PASSPHRASE }}
          source: "frontend.tgz"
          target: "/var/www"
          overwrite: true

      - name: Unpack frontend on server (atomic)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          port: ${{ secrets.SSH_PORT || 22 }}
          key: ${{ secrets.VPS_SSH_KEY }}
          passphrase: ${{ secrets.VPS_SSH_PASSPHRASE }}
          script: |
            set -e
            cd /var/www
            mkdir -p crm-frontend .releases
            rm -rf .releases/frontend_new
            mkdir -p .releases/frontend_new
            tar -xzf frontend.tgz -C .releases/frontend_new
            if [ -d ".releases/frontend_new/${{ env.FE_OUT }}" ]; then
              rsync -a --delete --exclude='.well-known' ".releases/frontend_new/${{ env.FE_OUT }}/" "crm-frontend/"
            else
              rsync -a --delete --exclude='.well-known' ".releases/frontend_new/" "crm-frontend/"
            fi
            rm -f frontend.tgz

      - name: Pack backend source
        run: |
          set -e
          EXCLUDES=(
            --exclude="${{ env.BE_DIR }}/node_modules"
            --exclude="${{ env.BE_DIR }}/.git"
            --exclude="${{ env.BE_DIR }}/.github"
            --exclude="${{ env.BE_DIR }}/.env*"
          )
          tar -czf backend.tgz "${EXCLUDES[@]}" "${{ env.BE_DIR }}"

      - name: Upload backend archive
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          port: ${{ secrets.SSH_PORT || 22 }}
          key: ${{ secrets.VPS_SSH_KEY }}
          passphrase: ${{ secrets.VPS_SSH_PASSPHRASE }}
          source: "backend.tgz"
          target: "/var/www"
          overwrite: true

      - name: Unpack backend on server (atomic)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          port: ${{ secrets.SSH_PORT || 22 }}
          key: ${{ secrets.VPS_SSH_KEY }}
          passphrase: ${{ secrets.VPS_SSH_PASSPHRASE }}
          script: |
            set -e
            cd /var/www
            mkdir -p crm-backend .releases
            rm -rf .releases/backend_new
            mkdir -p .releases/backend_new
            tar -xzf backend.tgz -C .releases/backend_new
            if [ -d ".releases/backend_new/backend" ]; then
              rsync -a --delete --exclude=".schema.sha256" ".releases/backend_new/backend/" "crm-backend/"
            elif [ -d ".releases/backend_new/Backend" ]; then
              rsync -a --delete --exclude=".schema.sha256" ".releases/backend_new/Backend/" "crm-backend/"
            else
              rsync -a --delete --exclude=".schema.sha256" ".releases/backend_new/" "crm-backend/"
            fi
            rm -f backend.tgz

      # Делаем backend.env локально БЕЗ проблем кавычек/CRLF и грузим на сервер (без heredoc-индента)
      - name: Prepare backend .env file
        env:
          BACKEND_ENV: ${{ secrets.BACKEND_ENV }}
        run: |
          set -e
          python3 - <<'PY'
          import os
          from pathlib import Path

          data = os.environ.get("BACKEND_ENV", "")
          data = data.replace("\r\n", "\n").replace("\r", "\n")

          if not data.strip():
              raise SystemExit("BACKEND_ENV is empty")

          Path("backend.env").write_text(data.rstrip("\n") + "\n", encoding="utf-8")
          PY

      - name: Upload backend env file
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          port: ${{ secrets.SSH_PORT || 22 }}
          key: ${{ secrets.VPS_SSH_KEY }}
          passphrase: ${{ secrets.VPS_SSH_PASSPHRASE }}
          source: "backend.env"
          target: "/var/www"
          overwrite: true

      - name: Move backend .env into place (chmod 640)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          port: ${{ secrets.SSH_PORT || 22 }}
          key: ${{ secrets.VPS_SSH_KEY }}
          passphrase: ${{ secrets.VPS_SSH_PASSPHRASE }}
          script: |
            set -e
            cd /var/www
            test -f backend.env
            mkdir -p crm-backend
            # более безопасные права по умолчанию
            umask 027
            mv -f backend.env crm-backend/.env
            chmod 640 crm-backend/.env

      - name: Install Node and pm2 on server if missing
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          port: ${{ secrets.SSH_PORT || 22 }}
          key: ${{ secrets.VPS_SSH_KEY }}
          passphrase: ${{ secrets.VPS_SSH_PASSPHRASE }}
          script: |
            set -e
            if ! command -v node >/dev/null 2>&1; then
              curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
              sudo apt-get install -y nodejs
            fi
            if ! command -v pm2 >/dev/null 2>&1; then
              sudo npm i -g pm2
            fi

      - name: Install backend deps, auto-migrate on schema change, restart pm2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          port: ${{ secrets.SSH_PORT || 22 }}
          key: ${{ secrets.VPS_SSH_KEY }}
          passphrase: ${{ secrets.VPS_SSH_PASSPHRASE }}
          envs: PRISMA_ACCEPT_DATA_LOSS
          script: |
            set -e
            cd /var/www/crm-backend

            export HUSKY=0
            npm ci --omit=dev --no-audit --no-fund || npm install --omit=dev --no-audit --no-fund

            # вычисляем текущий хэш схемы
            CURR_HASH=""
            if [ -f prisma/schema.prisma ]; then
              CURR_HASH=$(sha256sum prisma/schema.prisma | awk '{print $1}')
            fi
            PREV_HASH=$(cat .schema.sha256 2>/dev/null || echo "")

            SCHEMA_CHANGED=0
            if [ "$CURR_HASH" != "$PREV_HASH" ]; then
              SCHEMA_CHANGED=1
              echo "Prisma schema changed: $PREV_HASH -> $CURR_HASH"
            else
              echo "Prisma schema unchanged."
            fi

            # На всякий случай — всегда сгенерировать клиент
            npx prisma generate || true

            if [ "$SCHEMA_CHANGED" -eq 1 ]; then
              echo "Checking migrations..."
              HAS_MIGRATIONS=0
              if [ -d prisma/migrations ] && [ "$(find prisma/migrations -mindepth 1 -maxdepth 1 -type d | wc -l | xargs)" -gt 0 ]; then
                HAS_MIGRATIONS=1
              fi

              if [ "$HAS_MIGRATIONS" -eq 1 ]; then
                echo "Running 'prisma migrate deploy'..."
                npx prisma migrate deploy
              else
                echo "No migrations found. Running 'prisma db push'..."
                if [ "${PRISMA_ACCEPT_DATA_LOSS}" = "yes" ] || [ "${PRISMA_ACCEPT_DATA_LOSS}" = "true" ]; then
                  npx prisma db push --accept-data-loss
                else
                  npx prisma db push
                fi
              fi

              # записываем новый хэш только если все прошло успешно
              echo -n "$CURR_HASH" > .schema.sha256
            fi

            # старт/перезапуск pm2
            if npm run | grep -qE " start"; then
              pm2 reload crm-backend || pm2 start npm --name crm-backend -- run start
            else
              pm2 delete crm-backend || true
              pm2 start node --name crm-backend -- src/server.js
            fi
            pm2 save

      - name: Backend health check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          port: ${{ secrets.SSH_PORT || 22 }}
          key: ${{ secrets.VPS_SSH_KEY }}
          passphrase: ${{ secrets.VPS_SSH_PASSPHRASE }}
          script: |
            set -e
            curl -fsSI -H "Host: ${{ secrets.PRIMARY_DOMAIN || 'gsse.work' }}" http://127.0.0.1/api/health || true

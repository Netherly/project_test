name: deploy-crm

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ secrets.NODE_VERSION || '20' }}

      - name: Detect frontend/backend dirs
        run: |
          if [ -d Frontend ]; then echo "FE_DIR=Frontend" >> $GITHUB_ENV; else echo "FE_DIR=frontend" >> $GITHUB_ENV; fi
          if [ -d Backend ]; then echo "BE_DIR=Backend"  >> $GITHUB_ENV; else echo "BE_DIR=backend"  >> $GITHUB_ENV; fi

      # 1) Пишем prod-env
      - name: Write frontend .env.production
        run: |
          cd "${{ env.FE_DIR }}"
          printf "%s\n" "${{ secrets.FRONTEND_ENV }}" > .env.production || true

      # 2) Удаляем любые другие .env*, которые могут перебить
      - name: Remove other env files
        working-directory: ./${{ env.FE_DIR }}
        run: |
          rm -f .env .env.local .env.development .env.development.local .env.production.local || true

      # 3) Валидируем и экспортируем VITE_API_URL из .env.production
      - name: Validate & export VITE_API_URL
        working-directory: ./${{ env.FE_DIR }}
        run: |
          echo "----- .env.production (first 50 lines) -----"
          sed -n '1,50p' .env.production || true
          echo "--------------------------------------------"
          URL=$(grep -E '^VITE_API_URL=' .env.production | sed 's/^VITE_API_URL=//')
          if [ -z "$URL" ]; then
            echo "VITE_API_URL is missing in FRONTEND_ENV" >&2
            exit 1
          fi
          echo "VITE_API_URL=$URL" >> $GITHUB_ENV

      - name: Install & Build frontend
        working-directory: ./${{ env.FE_DIR }}
        env:
          VITE_API_URL: ${{ env.VITE_API_URL }}
        run: |
          npm ci || npm install
          npm run build || npm run build:prod || echo "no build script"

      - name: Detect FE_OUT
        run: |
          if [ -d "${{ env.FE_DIR }}/dist" ]; then echo "FE_OUT=dist" >> $GITHUB_ENV; else echo "FE_OUT=build" >> $GITHUB_ENV; fi
          echo "FE_DIR=${{ env.FE_DIR }} FE_OUT=${{ env.FE_OUT }}"
          test -d "${{ env.FE_DIR }}/${{ env.FE_OUT }}" || (echo "Build dir not found" && exit 1)
          find "${{ env.FE_DIR }}/${{ env.FE_OUT }}" -maxdepth 1 -type f | head -n 10

      - name: Fail if bundle contains bad base url
        run: |
          set -e
          echo "Searching for '/undefined/' in bundle..."
          if grep -RIn --no-messages "/undefined/" "${{ env.FE_DIR }}/${{ env.FE_OUT }}" ; then
            echo "Bundle contains '/undefined/'. Check VITE_API_URL!" >&2
            exit 1
          fi
          echo "Searching for 'localhost:3000' in bundle..."
          if grep -RIn --no-messages "localhost:3000" "${{ env.FE_DIR }}/${{ env.FE_OUT }}" ; then
            echo "Bundle contains 'localhost:3000'. Fix VITE_API_URL or client fallback." >&2
            exit 1
          fi
          echo "OK: bundle URLs look clean"

      - name: Pack frontend build
        run: |
          tar -C "${{ env.FE_DIR }}" -czf frontend.tgz "${{ env.FE_OUT }}"

      - name: Upload frontend archive
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          port: ${{ secrets.SSH_PORT || 22 }}
          key: ${{ secrets.VPS_SSH_KEY }}
          passphrase: ${{ secrets.VPS_SSH_PASSPHRASE }}
          source: "frontend.tgz"
          target: "/var/www"
          overwrite: true

      - name: Unpack frontend on server (atomic)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          port: ${{ secrets.SSH_PORT || 22 }}
          key: ${{ secrets.VPS_SSH_KEY }}
          passphrase: ${{ secrets.VPS_SSH_PASSPHRASE }}
          script: |
            set -e
            cd /var/www
            mkdir -p crm-frontend .releases
            rm -rf .releases/frontend_new
            mkdir -p .releases/frontend_new
            tar -xzf frontend.tgz -C .releases/frontend_new
            if [ -d ".releases/frontend_new/${{ env.FE_OUT }}" ]; then
              rsync -a --delete --exclude='.well-known' ".releases/frontend_new/${{ env.FE_OUT }}/" "crm-frontend/"
            else
              rsync -a --delete --exclude='.well-known' ".releases/frontend_new/" "crm-frontend/"
            fi
            rm -f frontend.tgz

      - name: Pack backend source (with prisma hash)
        run: |
          set -e
          # подготовим файл с хэшем схемы (если схемы нет — пусто)
          if [ -f "${{ env.BE_DIR }}/prisma/schema.prisma" ]; then
            (cd "${{ env.BE_DIR }}" && sha256sum prisma/schema.prisma | awk '{print $1}') > "${{ env.BE_DIR }}/.schema.sha256"
          else
            echo -n "" > "${{ env.BE_DIR }}/.schema.sha256"
          fi
          EXCLUDES=(
            --exclude="${{ env.BE_DIR }}/node_modules"
            --exclude="${{ env.BE_DIR }}/.git"
            --exclude="${{ env.BE_DIR }}/.github"
            --exclude="${{ env.BE_DIR }}/.env*"
          )
          tar -czf backend.tgz "${EXCLUDES[@]}" "${{ env.BE_DIR }}"

      - name: Upload backend archive
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          port: ${{ secrets.SSH_PORT || 22 }}
          key: ${{ secrets.VPS_SSH_KEY }}
          passphrase: ${{ secrets.VPS_SSH_PASSPHRASE }}
          source: "backend.tgz"
          target: "/var/www"
          overwrite: true

      - name: Unpack backend on server (atomic)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          port: ${{ secrets.SSH_PORT || 22 }}
          key: ${{ secrets.VPS_SSH_KEY }}
          passphrase: ${{ secrets.VPS_SSH_PASSPHRASE }}
        # Распаковываем и кладем исходники в crm-backend
          script: |
            set -e
            cd /var/www
            mkdir -p crm-backend .releases
            rm -rf .releases/backend_new
            mkdir -p .releases/backend_new
            tar -xzf backend.tgz -C .releases/backend_new
            if [ -d ".releases/backend_new/backend" ]; then
              rsync -a --delete ".releases/backend_new/backend/" "crm-backend/"
            elif [ -d ".releases/backend_new/Backend" ]; then
              rsync -a --delete ".releases/backend_new/Backend/" "crm-backend/"
            else
              rsync -a --delete ".releases/backend_new/" "crm-backend/"
            fi
            rm -f backend.tgz

      - name: Write backend .env on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          port: ${{ secrets.SSH_PORT || 22 }}
          key: ${{ secrets.VPS_SSH_KEY }}
          passphrase: ${{ secrets.VPS_SSH_PASSPHRASE }}
          script: |
            cat > /var/www/crm-backend/.env << 'EOF'
            ${{ secrets.BACKEND_ENV }}
            EOF
            chmod 640 /var/www/crm-backend/.env

      - name: Install Node and pm2 on server if missing
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          port: ${{ secrets.SSH_PORT || 22 }}
          key: ${{ secrets.VPS_SSH_KEY }}
          passphrase: ${{ secrets.VPS_SSH_PASSPHRASE }}
          script: |
            if ! command -v node >/dev/null 2>&1; then
              curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
              sudo apt-get install -y nodejs
            fi
            if ! command -v pm2 >/dev/null 2>&1; then
              sudo npm i -g pm2
            fi

      - name: Install backend deps, auto-migrate on schema change, restart pm2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          port: ${{ secrets.SSH_PORT || 22 }}
          key: ${{ secrets.VPS_SSH_KEY }}
          passphrase: ${{ secrets.VPS_SSH_PASSPHRASE }}
          envs: PRISMA_ACCEPT_DATA_LOSS
          script: |
            set -e
            cd /var/www/crm-backend

            export HUSKY=0
            npm ci --omit=dev || npm install --omit=dev

            # вычисляем текущий хэш схемы
            CURR_HASH=""
            if [ -f prisma/schema.prisma ]; then
              CURR_HASH=$(sha256sum prisma/schema.prisma | awk '{print $1}')
            fi
            PREV_HASH=$(cat .schema.sha256 2>/dev/null || echo "")

            SCHEMA_CHANGED=0
            if [ "$CURR_HASH" != "$PREV_HASH" ]; then
              SCHEMA_CHANGED=1
              echo "Prisma schema changed: $PREV_HASH -> $CURR_HASH"
            else
              echo "Prisma schema unchanged."
            fi

            # На всякий случай — всегда сгенерировать клиент
            npx prisma generate || true

            if [ "$SCHEMA_CHANGED" -eq 1 ]; then
              echo "Checking migrations..."
              HAS_MIGRATIONS=0
              if [ -d prisma/migrations ] && [ "$(find prisma/migrations -mindepth 1 -maxdepth 1 -type d | wc -l | xargs)" -gt 0 ]; then
                HAS_MIGRATIONS=1
              fi

              if [ "$HAS_MIGRATIONS" -eq 1 ]; then
                echo "Running 'prisma migrate deploy'..."
                npx prisma migrate deploy
              else
                echo "No migrations found. Running 'prisma db push'..."
                if [ "${PRISMA_ACCEPT_DATA_LOSS}" = "yes" ] || [ "${PRISMA_ACCEPT_DATA_LOSS}" = "true" ]; then
                  npx prisma db push --accept-data-loss
                else
                  # попытаемся без accept-data-loss (упадет при разрушительных изменениях)
                  npx prisma db push
                fi
              fi

              # записываем новый хэш, только если все прошло успешно
              echo -n "$CURR_HASH" > .schema.sha256
            fi

            # старт/перезапуск pm2
            if npm run | grep -qE " start"; then
              pm2 reload crm-backend || pm2 start npm --name crm-backend -- run start
            else
              pm2 delete crm-backend || true
              pm2 start node --name crm-backend -- src/server.js
            fi
            pm2 save

      - name: Backend health check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          port: ${{ secrets.SSH_PORT || 22 }}
          key: ${{ secrets.VPS_SSH_KEY }}
          passphrase: ${{ secrets.VPS_SSH_PASSPHRASE }}
          script: |
            set -e
            curl -fsSI -H "Host: ${{ secrets.PRIMARY_DOMAIN || 'gsse.work' }}" http://127.0.0.1/api/health || true
